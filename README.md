# Архитектура компьютера  
# Лабораторная работа №3 

## О проекте

+ Степанов Михаил Алексеевич
+  `asm | acc | neum | mc | tick | struct | stream | mem | prob5`

![Графическое представление проекта](/media/LabPlan.jpg)

***

## Язык программирования [Assembler]

Примечания:
+ Каждая строка рассматривается как отдельная операция (или метка).
+ Модель вычислений построена вокруг аккумулятора, результат всех вычислений записывается в аккумулятор и берется из него же.
+ Переменные имеют глобальную область видимости.

### Синтаксис языка

``` ebnf
<Program>  := ".data:" <Pointers> ".text:" <Commands>
           | ".text" <Commands>
          
<Pointers> := ""
           | <Pointer> <Pointers>
          
<Pointer>  := <Word> <Number>
           | <Word> "'" <Word> "'"
        
<Commands> := ""
           | <Command> <Commands>
           
<Command> := <Op0>
           | <Op1> <Number>
           | <Op1> <Word>
           | <OpJmp> "." <Word>
           | "." <Word> ":"
           
<Op0>      := "prt" | "rd" | "hlt"

<Op1>      := "ld" | "sv" | "add" | "sub" | "mul" | "div" | "cmp" | "pprt"

<OpJmp>    := "jmp" | "je" | "jne" | "jg" | "jl" | "jc"

<Word>     := <letter> <chars> 

<chars>    := <AnyChar> <chars>
           | ""

<AnyChar>  := <letter> | <digit>

<letter>   := "a" | "b" | ... | "z" | "A" | "B" | ... | "Z" | "_"

<Number>   := <digit> <Number>

<digit>    := "0" | "1" | ... | "9"
```

### Операции

Код начинается с точки входа (метки text) и выполняется последовательно. Операции:
+ ld - Загрузить значение в аккумулятор.
+ sv - Сохранить значение в память по адресу.
+ rd - Прочитать следующий символ из области IO.
+ prt - Записать символ в область IO.
+ add - Прибавить значение к аккумулятору.
+ sub - Вычесть значение из аккумулятора.
+ mul - Умножить значение на аккумулятор.
+ div - Разделить аккумулятор на число.
+ cmp - Выставить флаги выполнения операции sub без записи результата в аккумулятор.
+ jmp - Безусловный переход.
+ je - Переход если Z=1.
+ jne - Переход если Z=0.
+ jg - Переход если P=1.
+ jl - Переход если P=0 && Z=0.
+ jc - Переход если C=1.
+ pprt - Распечатать символ находящийся по адресу, который хранится в указанной ячейке и инкрементировать.
+ hlt - Остановка моделирования.

Разрешается использование однострочных комментариев, они пишутся после символов "//"

***

## Система команд

Особенности процессора:

+ Машинное слово -- 64 бита, знаковое.
+ Используемые регистры:

| Мнемоника |          Описание           | Размерность |      Операции по изменению       |
|:---------:|:---------------------------:|:-----------:|:--------------------------------:|
|    ACC    |         Аккумулятор         |   64 бит    |   +1, ALU, Загрузка из команды   |
|   ADDR    |            Адрес            |   16 бит    | Загрузка из команды, RD, WR, MEM |
|    IP     |      Указатель команд       |   16 бит    |     +1, Загрузка из команды      |
|    ZCP    |     Флаги для переходов     |   3 бита    |               ALU                |
|    SC     |       Счетчик тактов        |    8 бит    |              +1, 0               |
|    WR     | Указатель на область записи |   16 бит    |                +1                |
|    RD     | Указатель на область чтения |   16 бит    |                +1                |

## Набор инструкций

Синтаксис и мнемоники совпадают.

+ В качестве аргумента операций перехода может быть использована метка.
+ В качестве аргументов остальных операций может быть использован указатель (по его имени) или число.

| Syntax | Кол-во тактов |  Аргумент  |                                   Комментарий                                    |
|:------:|:-------------:|:----------:|:--------------------------------------------------------------------------------:|
|  hlt   |       0       |     -      |                               Остановка модуляции                                |             
|   ld   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|   sv   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|  prt   |       2       |     -      |                        Распечатывает символ по адресу WR                         |             
|   rd   |       2       |     -      |                            Читает символ по адресу RD                            |             
|  add   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|  sub   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|  mul   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|  div   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|  cmp   |      1/2      | value/addr |                      Количество тактов зависит от адресации                      |             
|  jmp   |       1       |    addr    |                               Безусловный переход                                |             
|   je   |       1       |    addr    |                                Переход по условию                                |             
|  jne   |       1       |    addr    |                                Переход по условию                                |             
|   jg   |       1       |    addr    |                                Переход по условию                                |             
|   jl   |       1       |    addr    |                                Переход по условию                                |             
|   jc   |       1       |    addr    |                                Переход по условию                                |             
|  pprt  |       9       |    addr    | Инкриминирует значение по адресу печатает символ находящийся по адресу из ячейки |             

### Кодирование инструкций

+ Машинный код хранится в виде объекта JSON.
+ В объекте три поля:
1. pointers - объект JSON: ключ - номер указателя, значение - данные, хранимые по указателю
2. labels - объект JSON: ключ - номер метки, значение - значение IP для перехода.
3. program - список JSON объектов: Одна инструкция - один объект, индекс - адрес для перехода.

## Транслятор

Интерфейс командной строки: `translator.py <input_file> <output_file>`

Реализовано в модуле: [translator](src/translator.py)

Этапы трансляции:
1. Поиск секций, меток и указателей по файлу.
2. Замена меток и указателей на условные символы и проверка их корректности.
3. Трансформирование текста программы в последовательность термов.

## Модель процессора

Интерфейс командной строки: `machine.py <parsed_file> [input_file]`

Реализовано в модуле: [machine](src/machine.py)

Было принято решение не разделять DataPath и ControlUnit.

![схема машины](media/machine_scheme.jpg)

Сигналы (обрабатываются за один такт, реализованы в виде методов класса):

+ latch_acc -- защёлкнуть аккумулятор. Принимает управляющий сигнал, указывающий на источник данных;
+ latch_addr -- защёлкнуть адресный регистр. Принимает управляющий сигнал, указывающий на источник данных;
+ latch_step_counter -- защелкнуть счетчик шагов исполнения инструкции. Принимает управляющий сигнал, указывающий на источник данных;
+ latch_ip -- защелкнуть instruction pointer. Принимает управляющий сигнал, указывающий на источник данных;
+ latch_mem -- выгрузить данные из аккумулятора в память;

Флаги:

+ Z - zero
+ P - positive
+ C - carry

Моделирование производилось на уровне микрокоманд.
Трансляция инструкций в последовательность сигналов - decode_and_execute.

Особенности модели:

+ Для журналирования используется модуль `logging`.
+ Количество исполненных операций ограничено константой.
+ Остановка модуляции определяется по возвращаемому значению функции.
+ Запуск симуляции происходит при вызове функции `simulate`.
