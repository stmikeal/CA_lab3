# Архитектура компьютера  
# Лабораторная работа №3 

## О проекте

+ Степанов Михаил Алексеевич
+  `asm | acc | neum | mc | tick | struct | stream | mem | prob5`

![Графическое представление проекта](/media/LabPlan.jpg)

Примечания:
+ Размер слова равен 32 бита, для упрощения реализации языка.
+ Форма языка программирования приведена для листинга программы после макропроцессора.
+ Для упрощения БНФ в некоторых местах использованы регулярные выражения, чтобы не описывать строки и числа через правила БНФ.

***

## Язык программирования [Assembler]

``` ebnf
program ::= (macro
        | data
        | command) (""|";" .*) program

macro ::= "%define" .+ .*

data ::= string "dd" number

command ::= label command
        | operation

label ::= (""|".") string ":"

operation ::= op0
        | s_op1 arg
        | mem_op1 mem_cell
        | op2 mem_cell "," arg
        | jump_op string

op0 ::= "ret" | "nop"

s_op1 ::= "push" | "mul" | "div" | "test"

mem_op1 ::= "pop" | "inc" | "dec" | "neg" | "not"

op2 ::= "mov" | "add" | "sub" | "cmp" | "xor" | "and" | "or" 

jump_op ::= "jmp" | "je" | "jne" | "jg" | "jl" | "jng" | "jnl" | "loop" | "call"

arg ::= mem_cell | number

mem_cell ::= reg | | "[" raw_arg "]"

raw_arg ::= number | reg

reg ::= "eax" | "ebx" | "ecx" | "edx" 
        | "esi" | "edi" | "esp" | "eip"
        | "r8" | "r9" | "r10" | "r11" 
        | "r12" | "r13" | "r14" | "r15"

string ::= [a-zA-Z]\w*

number ::= \d+ | "0x" (?:\d|[AaBbCcDdEeFf])+ | "0b" (?:[01])+
```
Код начинается с точки входа (метки start) и выполняется последовательно. Операции:
+ mov -- помещает значение правого операнда в левый
+ add -- увеличивает значение правого операнда на левый
+ sub -- уменьшает значение правого операнда на левый
+ mul -- увеличивает eax в <операнд> раз (если результат не помещается, то старшая часть кладется в edx)
+ div -- уменьшает eax в <операнд> раз (остаток кладется в edx)
+ cmp -- выставляет флаги выполнения операции вычитания без фактического выполнения операции
+ xor -- побитовая операция исключающее-или, результат записывается в левый регистр
+ and -- побитовая конъюнкция, результат записывается в левый регистр
+ or -- побитовая дизъюнкция, результат записывается в левый регистр
+ push -- кладет число на стек
+ pop -- получает верхнее число со стека и кладет его в регистр
+ inc -- инкрементирует значение ячейки
+ dec -- декрементирует значение ячейки
+ neg -- меняет знак у числа (работает для доп кода)
+ not -- инвертирует все биты числа
+ test -- выставляет флаги для указанного числа
+ nop -- операция пустышка
+ ret -- возврат из функции
+ jmp -- безусловный переход
+ je -- переход если ZF
+ jne -- переход если не ZF
+ jg -- переход если не SF и не ZF
+ jl -- переход если SF и не ZF
+ jng -- переход если SF или ZF
+ jnl -- переход если не SF или ZF
+ loop -- декремент ecx, переход если ZF
+ call -- вызов функции    

Поддерживается два типа меток:
+ локальные -- перед меткой указывается ".", обращение к такой метке может происходит только из фунции, в которой они определены
+ глобальные -- указывается просто название метки, к ней возможно обращение из любого места программы и возможен вызов в качестве функции (при помощи call)

Разрешено использования однострочных комментариев. Все что находится в строке после знака ";" интерпретируется как комментарий.

***

## Организация памяти

В коде можно использовать регистры общего назначения, у некоторых из них есть рекомендумое применение:

+ eax -- аккумулятор
+ ebx -- регистр базы
+ ecx -- счетчик
+ edx -- регистр данных 
+ esi -- индекс источника
+ edi -- индекс приемника
+ esp -- регистр указателя стека
+ eip -- регистр флагов
+ r8, r9, r10, r11, r12, r13, r14, r15 - регистры общего назначения без рекомендованного применения

Регистр флагов (eip) содержит несколько флагов, которые используются для вычислений или переходов:

|№ бита|Обозначение|Описание            |
|:----:|:---------:|:------------------:|
|0     |CF         |Флаг переноса       |               
|2     |PF         |Флаг чётности       |               
|6     |ZF         |Флаг нуля           |               
|7     |SF         |Флаг знака          |               
|11    |OF         |Флаг переполнения   |     

Используется макропроцессор, может использоваться в качестве констант:
+ `%define` -- определение заменяемых литералов

Возможно использования кучи для хранения данных. Для этого необходимо сначала получить указатель на свободное место в куче:
+ <название указателя> <модификатор> <размер кучи> -- выделяемое место рассчитывается как <размер модификатора> * <размер кучи>

Поддерживаемые модификаторы указателя:
+ dd -- размечает кучу 4 байтовыми значениями

Обращение к куче происходит при помощи указания адреса ячейки в квадратных скобках. Пример:
```
array dd 10; array указатель на кучу, в которой выделены 40 байт
mov [array], 10; в первую ячейку кладется число 10 (которое занимает 4 байта)
```

Модель памяти процессора:
1. Память команд. Машинное слово -- 32 бита. Реализовано словарем, определяющим соответствие адреса ячейке.
2. Память данных. Машинное слово -- 32 бита. Реализовано словарем, определяющим соответствие адреса ячейке.
3. Стек. Машинное слово -- 32 бита. Реализовано словарем, определяющим соответствие адреса ячейке. Имеется регистр esp для указателя на текущий верх стека, по умолчанию находится в конце памяти.
4. Ассоциация меток памяти -- реализовано словарем соответствия меток памяти.
5. Указатель на кучу -- реализовано словарем соответствия указателей памяти.

В виду специфики архитектуры Фон Неймана все данные находятся в единой памяти и интерпретация данных лежит на плечах программиста.

## Система команд

Особенности процессора:

+ Машинное слово -- 32 бита, знаковое.
+ Память данных:
  + Адресуется через регистр data_address (может быть записан из аккумулятора)
  + Может быть записана:
    + Из аккумулятора rax (декремент/инкремент)
    + С порта ввода
  + Может быть прочитана в аккумулятор rax
+ Регистр аккумулятора rax:
  + Может быть подан на вывод
  + Используются флаги (см. Организация памяти)
+ Ввод-вывод -- порты ввода/вывода.
+ prog_counter -- счётчик команд:
  + Инкрементируется после каждой инструкции или изменяется после перехода

## Набор инструкций

Все пояснения см. Язык

|Syntax |Mnemonic   |Кол-во тактов  |
|:-----:|:---------:|:-------------:|
|0      |CF         |Флаг пере      |               
|2      |PF         |Флаг сти       |               
|6      |ZF         |Флаг           |               
|7      |SF         |Флаг           |               
|11     |OF         |Флаг олнения   |    