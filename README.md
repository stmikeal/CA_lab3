# Архитектура компьютера  
# Лабораторная работа №3 

## О проекте

+ Степанов Михаил Алексеевич
+  `asm | acc | neum | mc | tick | struct | stream | mem | prob5`

![Графическое представление проекта](/media/LabPlan.jpg)

Примечания:
+ Размер слова равен 32 бита, для упрощения реализации языка.
+ Форма языка программирования приведена для листинга программы после макропроцессора.
+ Для упрощения БНФ в некоторых местах использованы регулярные выражения, чтобы не описывать строки и числа через правила БНФ.

***

## Язык программирования [Assembler]

``` ebnf

```
Код начинается с точки входа (метки start) и выполняется последовательно. Операции:
+ ld
+ sv
+ rd
+ prt
+ add
+ sub
+ mul
+ div
+ cmp
+ jmp
+ je
+ jne
+ jg
+ jl
+ hlt 

Поддерживается два типа меток:
+ локальные -- перед меткой указывается ".", обращение к такой метке может происходит только из фунции, в которой они определены
+ глобальные -- указывается просто название метки, к ней возможно обращение из любого места программы и возможен вызов в качестве функции (при помощи call)

Разрешено использования однострочных комментариев. Все что находится в строке после знака ";" интерпретируется как комментарий.

***

## Организация памяти

В коде можно использовать регистры общего назначения, у некоторых из них есть рекомендумое применение:

+ eax -- аккумулятор
+ ebx -- регистр базы
+ ecx -- счетчик
+ edx -- регистр данных 
+ esi -- индекс источника
+ edi -- индекс приемника
+ esp -- регистр указателя стека
+ eip -- регистр флагов
+ r8, r9, r10, r11, r12, r13, r14, r15 - регистры общего назначения без рекомендованного применения

Регистр флагов (eip) содержит несколько флагов, которые используются для вычислений или переходов:

|№ бита|Обозначение|Описание            |
|:----:|:---------:|:------------------:|
|0     |CF         |Флаг переноса       |               
|2     |PF         |Флаг чётности       |               
|6     |ZF         |Флаг нуля           |               
|7     |SF         |Флаг знака          |               
|11    |OF         |Флаг переполнения   |     

Используется макропроцессор, может использоваться в качестве констант:
+ `%define` -- определение заменяемых литералов

Возможно использования кучи для хранения данных. Для этого необходимо сначала получить указатель на свободное место в куче:
+ <название указателя> <модификатор> <размер кучи> -- выделяемое место рассчитывается как <размер модификатора> * <размер кучи>

Поддерживаемые модификаторы указателя:
+ dd -- размечает кучу 4 байтовыми значениями

Обращение к куче происходит при помощи указания адреса ячейки в квадратных скобках. Пример:
```
array dd 10; array указатель на кучу, в которой выделены 40 байт
mov [array], 10; в первую ячейку кладется число 10 (которое занимает 4 байта)
```

Модель памяти процессора:
1. Память команд. Машинное слово -- 32 бита. Реализовано словарем, определяющим соответствие адреса ячейке.
2. Память данных. Машинное слово -- 32 бита. Реализовано словарем, определяющим соответствие адреса ячейке.
3. Стек. Машинное слово -- 32 бита. Реализовано словарем, определяющим соответствие адреса ячейке. Имеется регистр esp для указателя на текущий верх стека, по умолчанию находится в конце памяти.
4. Ассоциация меток памяти -- реализовано словарем соответствия меток памяти.
5. Указатель на кучу -- реализовано словарем соответствия указателей памяти.

В виду специфики архитектуры Фон Неймана все данные находятся в единой памяти и интерпретация данных лежит на плечах программиста.

## Система команд

Особенности процессора:

+ Машинное слово -- 32 бита, знаковое.
+ Память данных:
  + Адресуется через регистр data_address (может быть записан из аккумулятора)
  + Может быть записана:
    + Из аккумулятора rax (декремент/инкремент)
    + С порта ввода
  + Может быть прочитана в аккумулятор rax
+ Регистр аккумулятора rax:
  + Может быть подан на вывод
  + Используются флаги (см. Организация памяти)
+ Ввод-вывод -- порты ввода/вывода.
+ prog_counter -- счётчик команд:
  + Инкрементируется после каждой инструкции или изменяется после перехода

## Набор инструкций

Все пояснения см. Язык

|Syntax |Mnemonic   |Кол-во тактов  |
|:-----:|:---------:|:-------------:|
|0      |CF         |Флаг пере      |               
|2      |PF         |Флаг сти       |               
|6      |ZF         |Флаг           |               
|7      |SF         |Флаг           |               
|11     |OF         |Флаг олнения   |    